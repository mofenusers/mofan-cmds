#!/usr/bin/env node
const program = require("commander");
const inquirer = require("inquirer");
const shelljs = require("../utils/shelljsUtil");

// const jenkinsUrl = (app, env) =>
//   `http://192.168.0.163:8080/job/tenant-fe/job/${env}/job/${app}/build?token=jenkins-szhtxx-token `;

const questions = [
  {
    type: "checkbox",
    name: "gitBranchs",
    message: "è¯·é€‰æ‹©æƒ³è¦æ›´æ–°çš„åˆ†æ”¯",
    choices: [
      {
        name: "dev",
        value: "dev",
      },
      {
        name: "test",
        value: "test",
      },
      {
        name: "uat",
        value: "uat",
        checked: true,
      },
    ],
  },
];
program
  .option("-s, --source <source>", "source branch")
  .option("-t, --targets [targets...]", "target branch")
  .action(function ({ source, targets }, args) {
    if (!source) {
      exec("git branch --show-current", (err, stdout, stderr) => {
        console.log("ğŸš€ ~ file: dash-acommit:66 ~ exec ~ stdout:", stdout);
        if (err) {
          // handle your error
          shelljs.exit(1);
        }

        dealwithBranchs(targets, stdout);
      });
    } else {
      dealwithBranchs(targets, source);
    }
    const run = (branchs, sourceBranch) => {
      branchs.forEach((branch) => {
        const { code, stderr } = shelljs.exec(
          `mofancmds autoMerge ${branch} ${sourceBranch}`
        );
        if (code !== 0) {
          console.log(
            "ğŸš€ ~ file: dash-updateCode:43 ~ gitBranchs.forEach ~ error",
            stderr
          );
          shelljs.exit(1);
        } else {
          shelljs.exec(`git push`);
        }
      });
      shelljs.exec(`git checkout ${sourceBranch}`);
    };

    const dealwithBranchs = (targetBranchs, sourceBranch) => {
      if (targetBranchs && targetBranchs.length) {
        run(targetBranchs, sourceBranch);
      } else {
        inquirer.prompt(questions).then((answer) => {
          const { gitBranchs } = answer;
          run(gitBranchs, sourceBranch);
        });
      }
    };
  })
  .parse(process.argv);
