#!/usr/bin/env node
const program = require("commander");
const shelljs = require("../utils/shelljsUtil");
const { askFortargetBranchs } = require("../utils/config");

// const jenkinsUrl = (app, env) =>
//   `http://192.168.0.163:8080/job/tenant-fe/job/${env}/job/${app}/build?token=jenkins-szhtxx-token `;

program
  .option("-s, --source <source>", "source branch")
  .option("-t, --targets [targets...]", "target branch")
  .action(function ({ source, targets }, args) {
    const run = (branchs, sourceBranch) => {
      branchs.forEach((branch) => {
        // ç”Ÿæˆå¤šä¸ªå­è¿›ç¨‹æ‰§è¡Œä»¥ä¸‹gitæ“ä½œ
        // 1ã€ç”Ÿæˆå¤šä¸ªworktree
        // 2ã€åˆ‡æ¢åˆ°æ¯ä¸ªworktree
        // 3ã€åˆ‡æ¢åˆ°branch
        // 4ã€merge sourceBranch
        // 5ã€git push
        // 6ã€åˆ é™¤worktree
        const res = shelljs.exec(
          `git worktree add -b ${branch} ${branch} && cd ${branch}-merge && git checkout ${branch} && git merge ${sourceBranch} && git push && cd.. && git worktree remove ${branch}`
        );
        console.log("ðŸš€ ~ file: dash-batchmerge:25 ~ branchs.forEach ~ res:", res)
      });
    };

    const dealwithBranchs = (targetBranchs, sourceBranch) => {
      if (targetBranchs && targetBranchs.length) {
        run(targetBranchs, sourceBranch);
      } else {
        askFortargetBranchs().then((answer) => {
          const { gitBranchs } = answer;
          run(gitBranchs, sourceBranch);
        });
      }
    };

    dealwithBranchs(targets, source);
  })
  .parse(process.argv);
