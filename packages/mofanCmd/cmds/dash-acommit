#!/usr/bin/env node
const program = require("commander");
const shelljs = require("../utils/shelljsUtil");
const { targetBranchQuestions } = require("../utils/config");
const { ask } = require("../utils/inquireUtil");

const typeQuestions = [
  {
    type: "list",
    name: "commitType",
    message: "commitçš„ç±»åž‹",
    choices: [
      {
        name: "feat",
        value: "feat",
        checked: true,
      },
      {
        name: "fix",
        value: "fix",
      },
      {
        name: "style",
        value: "style",
      },
      {
        name: "docs",
        value: "docs",
      },
      {
        name: "pref",
        value: "pref",
      },
      {
        name: "build",
        value: "build",
      },
    ],
  },
];

const descQuestion = [
  {
    type: "input",
    name: "desc",
    message: "commitçš„æè¿°",
  },
];

const updateCodeQuestion = [
  {
    type: "confirm",
    name: "updateCode",
    message: "æ˜¯å¦æ›´æ–°ä»£ç è‡³è¿œç¨‹çŽ¯å¢ƒåˆ†æ”¯",
  },
];

const updateCodeFn = () => {
  const { code, stdout, stderr } = shelljs.exec(`git branch --show-current`);
  const currentBranch = stdout.replace("\n", "");
  console.log(
    "ðŸš€ ~ file: dash-acommit:62 ~ updateCodeFn ~ stdout:",
    currentBranch
  );
  console.log(
    "ðŸš€ ~ file: dash-acommit:66 ~ exec ~ currentBranch:",
    currentBranch
  );
  if (code !== 0) {
    // handle your error
    console.error(
      "ðŸš€ ~ file: dash-updateCode:43 ~ gitBranchs.forEach ~ error",
      stderr
    );
    shelljs.exit(1);
  }
  return ask([
    {
      type: "confirm",
      name: "updateCodeConfirm",
      message: `ä½ å½“å‰åœ¨${currentBranch}åˆ†æ”¯ï¼Œç¡®è®¤æ›´æ–°ä»£ç è‡³çŽ¯å¢ƒåˆ†æ”¯å—ï¼Ÿ`,
    },
  ]).then(({ updateCodeConfirm }) => {
    return {
      updateCodeConfirm,
      currentBranch,
    };
  });
};

program
  .action(function () {
    const run = (commitType, desc) => {
      shelljs.exec(`git add .`);
      const { code, stderr } = shelljs.exec(
        `git commit -m "${commitType}: ${desc}"`
      );

      if (code !== 0) {
        console.error(
          "ðŸš€ ~ file: dash-updateCode:43 ~ gitBranchs.forEach ~ error",
          stderr
        );
        shelljs.exit(1);
      } else {
        // shelljs.exec(`git push`);
        shelljs.exec(`git status`);
      }
    };

    ask(typeQuestions)
      .then((answer) => {
        const { commitType } = answer;
        return ask(descQuestion).then(({ desc }) => run(commitType, desc));
      })
      .then(() => {
        return ask(updateCodeQuestion).then(
          ({ updateCode }) => updateCode && updateCodeFn()
        );
      })
      .then(({ updateCodeConfirm, currentBranch }) => {
        if (updateCodeConfirm) {
          return ask(targetBranchQuestions).then(({ gitBranchs }) => {
            console.log(
              "ðŸš€ ~ file: dash-acommit:120 ~ returnask ~ `mofancmds ubmerge -s ${stdout} -t ${gitBranchs.join()}`:",
              `mofancmds ubmerge -s ${currentBranch} -t ${gitBranchs}`
            );
            shelljs.exec(
              `mofancmds ubmerge -s ${currentBranch} -t ${gitBranchs.join(" ")}`
            );
          });
        } else {
          shelljs.exit(1);
        }
      });
  })
  .parse(process.argv);
